esphome:
  name: esphome-web-0f4168
  friendly_name: ESPHome Web 0f4168
  min_version: 2025.9.0
  name_add_mac_suffix: false

esp32:
  variant: esp32
  framework:
    type: esp-idf

# Enable logging
logger:

# Enable Home Assistant API
api:

# Allow Over-The-Air updates
ota:
- platform: esphome

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  power_save_mode: none
  ap:
    ssid: "esphome-web-0f4168 Fallback"
    password: "fallback1234"

preferences:
  flash_write_interval: 1min


# Provide a captive portal so users can connect to the fallback AP
captive_portal:


# LED strip with segmented addressable lights
light:
  - platform: esp32_rmt_led_strip
    id: full_strip
    name: "Full Strip"
    pin: GPIO4
    num_leds: 83
    chipset: WS2812
    rgb_order: GRB
    internal: true   # Prevent conflicts when partitioning
    restore_mode: RESTORE_DEFAULT_OFF 
    effects:
      - random:
      - strobe:
      - flicker:
      - addressable_rainbow:
      - addressable_color_wipe:
      - addressable_scan:
      - addressable_twinkle:
      - addressable_fireworks:

  # Side segment: LEDs 0-22
  - platform: partition
    name: "Side Strip"
    id: side_strip
    restore_mode: RESTORE_DEFAULT_OFF 
    segments:
      - id: full_strip
        from: 0
        to: 22
    effects:
      - random:
      - strobe:
      - flicker:
      - addressable_rainbow:
      - addressable_color_wipe:
      - addressable_scan:
      - addressable_twinkle:
      - addressable_fireworks:

  # Countertop segment: LEDs 23-82
  - platform: partition
    name: "Countertop Strip"
    id: countertop_strip
    restore_mode: RESTORE_DEFAULT_OFF
    segments:
      - id: full_strip
        from: 23
        to: 82
    effects:
      - random:
      - strobe:
      - flicker:
      - addressable_rainbow:
      - addressable_color_wipe:
      - addressable_scan:
      - addressable_twinkle:
      - addressable_fireworks:

# I2C bus for sensors
i2c:
  sda: GPIO21
  scl: GPIO22
  scan: true

# APDS9960 proximity sensor + motion template (uses existing I2C bus)
# IDs are prefixed with `web_` to avoid collisions with other devices.
apds9960:
  - id: web_apds
    # hardware sampling interval; change and reflash if you want
    update_interval: 100ms

number:
  - platform: template
    name: "Web APDS Threshold"
    id: web_apds_threshold_number
    lambda: |-
      return id(web_motion_threshold);
    min_value: 0
    max_value: 100
    step: 1
    set_action:
      - globals.set:
          id: web_motion_threshold
          value: !lambda 'return x;'
    disabled_by_default: true

  - platform: template
    name: "Web APDS Stable ms"
    id: web_apds_stable_ms_number
    lambda: |-
      return (float)id(web_motion_stable_ms);
    min_value: 0
    max_value: 60000
    step: 500
    set_action:
      - globals.set:
          id: web_motion_stable_ms
          value: !lambda 'return (int)x;'
    disabled_by_default: true

  - platform: template
    name: "Web APDS Refresh ms"
    id: web_apds_refresh_ms_number
    lambda: |-
      return (float)id(web_motion_refresh_ms);
    min_value: 10
    max_value: 10000
    step: 10
    set_action:
      - globals.set:
          id: web_motion_refresh_ms
          value: !lambda 'return (int)x;'
    disabled_by_default: true

globals:
  - id: web_motion_active
    type: bool
    initial_value: 'false'
    restore_value: false
  - id: web_motion_threshold
    type: float
    initial_value: '20.0'
    restore_value: true
  - id: web_motion_stable_ms
    type: int
    initial_value: '1000'
    restore_value: true
  - id: web_motion_refresh_ms
    type: int
    initial_value: '100'
    restore_value: true

# Template binary sensor for motion; visible in HA
binary_sensor:
  - platform: template
    name: "Web APDS Motion"
    id: web_apds_motion
    lambda: |-
      static unsigned long last_change = 0;
      static unsigned long last_process = 0;
      static bool state = false;
      const float threshold = id(web_motion_threshold);
      const unsigned long stable_ms = (unsigned long) id(web_motion_stable_ms);
      const unsigned long refresh_ms = (unsigned long) id(web_motion_refresh_ms);
      float prox = id(web_apds_proximity).state;
      unsigned long now = millis();
      if (now - last_process < refresh_ms) {
        return state;
      }
      last_process = now;
      if (prox > threshold) {
        last_change = now;
        if (!state) state = true;
      } else {
        if (now - last_change > stable_ms) {
          if (state) state = false;
        }
      }
      return state;
    on_press:
      - globals.set:
          id: web_motion_active
          value: 'true'
    on_release:
      - globals.set:
          id: web_motion_active
          value: 'false'

# BME688 environmental sensor using BSEC2 library (I2C)
# Define the BSEC2 hub component
bme68x_bsec2_i2c:
  id: bme68x_bsec2_hub
  address: 0x77
  model: bme688
  # Optional: you can set operating_age, sample_rate, supply_voltage, etc.

# Sensors that use the hub defined above
sensor:
  - platform: apds9960
    type: proximity
    name: "Web APDS Proximity"
    id: web_apds_proximity
    disabled_by_default: true
    on_value:
      then:
        - lambda: |-
            ESP_LOGD("web_apds", "proximity=%f", x);

  - platform: bme68x_bsec2
    bme68x_bsec2_id: bme68x_bsec2_hub
    temperature:
      name: "BME688 Temperature"
    humidity:
      name: "BME688 Humidity"
    pressure:
      name: "BME688 Pressure"
    gas_resistance:
      name: "BME688 Gas Resistance"
    iaq:
      name: "BME688 IAQ"
    iaq_accuracy:
      name: "BME688 IAQ Accuracy"
    iaq_static:
      name: "BME688 Static IAQ"
    co2_equivalent:
      name: "BME688 CO2 Equivalent"
    breath_voc_equivalent:
      name: "BME688 Breath VOC Equivalent"

# # i2s_audio component for PDM microphone (bus definition)
# i2s_audio:
#   id: i2s_mic
#   i2s_bclk_pin: GPIO14   # bit clock pin
#   i2s_lrclk_pin: GPIO13   # leftâ€‘right clock (required)

# # PDM microphone using the i2s_audio component
# microphone:
#   - platform: i2s_audio
#     id: pdm_mic
#     i2s_audio_id: i2s_mic
#     adc_type: external
#     i2s_din_pin: GPIO33   # data pin for external ADC (changed from GPIO15 to avoid strapping warning)
#     pdm: true
#     sample_rate: 16000  # Hz
#     bits_per_sample: 16bit


# voice_assistant:
#   microphone: pdm_mic


# Optional web UI
web_server:
  port: 80